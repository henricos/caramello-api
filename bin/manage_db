#!/bin/bash
set -e

# Caramello Backend - Database Management Script

# Function to display usage
usage() {
    echo "Usage: $0 {init|migrate|upgrade|reset} [args]"
    echo ""
    echo "Commands:"
    echo "  init              Initialize the database (apply all migrations)"
    echo "  migrate \"msg\"     Create a new migration with the given message"
    echo "  upgrade           Apply pending migrations (same as init)"
    echo "  reset             Destroy and recreate the database (DATA LOSS WARNING)"
    echo ""
}

# Check if command is provided
if [ -z "$1" ]; then
    usage
    exit 1
fi

COMMAND=$1
shift

case "$COMMAND" in
    init|upgrade)
        echo "Applying migrations..."
        uv run alembic upgrade head
        ;;
    migrate)
        if [ -z "$1" ]; then
            echo "Error: Migration message required."
            echo "Usage: $0 migrate \"message\""
            exit 1
        fi
        echo "Creating migration: $1"
        uv run alembic revision --autogenerate -m "$1"
        ;;
    reset)
        echo "WARNING: This will destroy all data in the database."
        read -p "Are you sure you want to continue? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Aborted."
            exit 1
        fi

        # Detect database type from env or default to sqlite
        # Simple check: if DATABASE_URL contains "postgres", assume postgres.
        # Otherwise, check for sqlite file or default.
        
        # Load .env if exists to check variables (simple grep, not full parsing)
        if [ -f .env ]; then
            export $(grep -v '^#' .env | xargs)
        fi

        if [[ "$DATABASE_URL" == *"postgres"* ]] || [[ -n "$DB_HOST" ]]; then
            echo "Detected PostgreSQL environment."
            echo "Downgrading to base (dropping all tables)..."
            uv run alembic downgrade base
        else
            echo "Detected SQLite environment (default)."
            DB_FILE="database.db"
            if [ -f "$DB_FILE" ]; then
                echo "Removing $DB_FILE..."
                rm "$DB_FILE"
            else
                echo "$DB_FILE not found, nothing to delete."
            fi
        fi

        echo "Re-initializing database..."
        uv run alembic upgrade head
        echo "Database reset complete."
        ;;
    *)
        usage
        exit 1
        ;;
esac
