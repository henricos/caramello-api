#!/bin/bash
set -e

# Caramello API - Database Infrastructure Setup Script
# Functions:
# 1. Reads .env for target configuration
# 2. Asks for Admin credentials interactively
# 3. Checks if DB exists:
#    - If yes: Offers to DROP and RECREATE (Reset)
#    - If no: Creates it
# 4. Sets up permissions

# --- 1. PRE-FLIGHT CHECKS ---

# Check for psql
if ! command -v psql &> /dev/null; then
    echo "Error: 'psql' is not installed or not in PATH."
    echo "Please install the PostgreSQL client utilities."
    exit 1
fi

# Determine project root (assuming script is in bin/)
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Check for .env
if [ ! -f "$PROJECT_ROOT/.env" ]; then
    echo "Error: .env file not found at $PROJECT_ROOT/.env"
    echo "Please copy .env.example to .env and configure it first."
    exit 1
fi

# --- 2. LOAD CONFIGURATION ---

# Load env vars safely (exporting them for this script's session)
set -a
source "$PROJECT_ROOT/.env"
set +a

# Validate required vars
if [[ -z "$DB_USER" || -z "$DB_NAME" || -z "$DB_PASSWORD" || -z "$DB_HOST" ]]; then
    echo "Error: Missing required database variables in .env (DB_USER, DB_NAME, DB_PASSWORD, DB_HOST)."
    exit 1
fi

echo "=========================================================="
echo "    Caramello API - Database Setup & Reset Tool"
echo "=========================================================="
echo ""
echo "Target Configuration (from .env):"
echo "  Host:      $DB_HOST:${DB_PORT:-5432}"
echo "  Database:  $DB_NAME"
echo "  User:      $DB_USER"
echo ""

# --- 3. ADMIN CREDENTIALS ---

echo "To perform these operations, we need credentials for a database SUPERUSER."
echo "Usually this is 'postgres'."
echo ""
read -p "Enter Admin Username [default: postgres]: " ADMIN_USER
ADMIN_USER=${ADMIN_USER:-postgres}

# Read password silently
read -s -p "Enter Password for '$ADMIN_USER': " ADMIN_PASSWORD
echo ""
echo ""

# Export PGPASSWORD for psql commands to use (avoiding interactive prompt)
export PGPASSWORD="$ADMIN_PASSWORD"

# Test Admin Connection
if ! psql -h "$DB_HOST" -p "${DB_PORT:-5432}" -U "$ADMIN_USER" -d postgres -c "SELECT 1" &> /dev/null; then
    echo "Error: Could not connect to database at $DB_HOST as '$ADMIN_USER'."
    echo "Check your credentials and network connection."
    unset PGPASSWORD
    exit 1
fi

# --- 4. CHECK EXISTENCE & PLAN ---

DB_EXISTS=$(psql -h "$DB_HOST" -p "${DB_PORT:-5432}" -U "$ADMIN_USER" -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname='$DB_NAME'")

MODE="CREATE"

if [ "$DB_EXISTS" == "1" ]; then
    echo "(!) WARNING: Database '$DB_NAME' ALREADY EXISTS."
    echo ""
    echo "Do you want to DESTROY (Drop) the existing database and recreate it?"
    echo "This will result in PERMANENT DATA LOSS."
    echo ""
    read -p "Type 'yes' to Drop and Recreate, or anything else to Cancel: " CONFIRM
    
    if [ "$CONFIRM" != "yes" ]; then
        echo "Aborted by user."
        unset PGPASSWORD
        exit 0
    fi
    MODE="RESET"
else
    echo "Database '$DB_NAME' does not exist. Proceeding with creation."
fi

# --- 5. EXECUTION ---

echo ""
echo "Starting operation..."

# Connect to maintenance DB (postgres) to do the creates/drops
PSQL_ADMIN_CMD="psql -h $DB_HOST -p ${DB_PORT:-5432} -U $ADMIN_USER -d postgres"

if [ "$MODE" == "RESET" ]; then
    echo "[1/4] Dropping existing database..."
    # Disconnect other users first (Postgres specific)
    $PSQL_ADMIN_CMD -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = '$DB_NAME' AND pid <> pg_backend_pid();" > /dev/null
    $PSQL_ADMIN_CMD -c "DROP DATABASE \"$DB_NAME\";"
    
    echo "[2/4] Dropping existing user (if exists)..."
    $PSQL_ADMIN_CMD -c "DROP USER IF EXISTS \"$DB_USER\";"
fi

echo "[3/4] Creating user and database..."
# Check if user exists before trying to create (relevant for initial run or partial states)
USER_EXISTS=$($PSQL_ADMIN_CMD -tAc "SELECT 1 FROM pg_roles WHERE rolname='$DB_USER'")
if [ "$USER_EXISTS" != "1" ]; then
    $PSQL_ADMIN_CMD -c "CREATE USER \"$DB_USER\" WITH PASSWORD '$DB_PASSWORD';"
    echo "      - User '$DB_USER' created."
else
    # Optionally update password? For now just notify.
    echo "      - User '$DB_USER' already exists, skipping creation."
fi

$PSQL_ADMIN_CMD -c "CREATE DATABASE \"$DB_NAME\" OWNER \"$DB_USER\";"
echo "      - Database '$DB_NAME' created."

echo "[4/4] Configuring privileges..."
# Grant connect on database (redundant for owner but safe)
$PSQL_ADMIN_CMD -c "GRANT ALL PRIVILEGES ON DATABASE \"$DB_NAME\" TO \"$DB_USER\";"

# Connect TO THE NEW DB to grant schema privileges
# This is required for Postgres 15+ default public schema permissions changes
psql -h "$DB_HOST" -p "${DB_PORT:-5432}" -U "$ADMIN_USER" -d "$DB_NAME" -c "GRANT ALL ON SCHEMA public TO \"$DB_USER\";"

echo ""
echo "=========================================================="
echo "SUCCESS! Database initialized."
echo "=========================================================="
echo "Connection String format: postgresql://$DB_USER:*****@$DB_HOST:${DB_PORT:-5432}/$DB_NAME"

# Cleanup
unset PGPASSWORD
